<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tư vấn Ngành học FPT Polytechnic</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #ff6b6b 0%, #ff8e8e 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            font-weight: 700;
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .navigation {
            background: #f8f9fa;
            padding: 0;
            display: flex;
            border-bottom: 1px solid #e9ecef;
        }

        .nav-btn {
            flex: 1;
            padding: 20px;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            transition: all 0.3s ease;
            position: relative;
        }

        .nav-btn.active {
            background: white;
            color: #667eea;
        }

        .nav-btn:hover {
            background: #e9ecef;
        }

        .nav-btn.active:hover {
            background: white;
        }

        .content {
            padding: 40px;
            min-height: 600px;
        }

        .section {
            display: none;
        }

        .section.active {
            display: block;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .form-group {
            margin-bottom: 25px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
            font-size: 1rem;
        }

        .form-control {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            font-size: 1rem;
            transition: all 0.3s ease;
            background: #fafafa;
        }

        .form-control:focus {
            outline: none;
            border-color: #667eea;
            background: white;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 25px;
        }

        .checkbox-group {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 10px;
        }

        .checkbox-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 12px;
            background: #f8f9fa;
            border-radius: 8px;
            transition: all 0.3s ease;
        }

        .checkbox-item:hover {
            background: #e9ecef;
        }

        .checkbox-item input[type="checkbox"] {
            width: 18px;
            height: 18px;
            accent-color: #667eea;
        }

        .btn {
            padding: 15px 30px;
            border: none;
            border-radius: 10px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background: #5a6268;
            transform: translateY(-2px);
        }

        .loading {
            display: none;
            text-align: center;
            padding: 40px;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .results-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            border-radius: 15px;
            margin-bottom: 25px;
        }

        .results-card h3 {
            font-size: 1.8rem;
            margin-bottom: 15px;
        }

        .major-recommendation {
            background: white;
            color: #333;
            padding: 20px;
            border-radius: 10px;
            margin: 15px 0;
            border-left: 5px solid #ff6b6b;
        }

        .major-recommendation h4 {
            color: #667eea;
            margin-bottom: 10px;
            font-size: 1.3rem;
        }

        .history-item {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 15px;
            border-left: 4px solid #667eea;
        }

        .history-item .date {
            color: #6c757d;
            font-size: 0.9rem;
            margin-bottom: 10px;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #6c757d;
        }

        .empty-state img {
            width: 100px;
            height: 100px;
            opacity: 0.3;
            margin-bottom: 20px;
        }

        .progress-bar {
            background: #e9ecef;
            height: 6px;
            border-radius: 3px;
            overflow: hidden;
            margin: 20px 0;
        }

        .progress-fill {
            background: linear-gradient(90deg, #667eea, #764ba2);
            height: 100%;
            width: 0%;
            transition: width 0.3s ease;
        }



        /* Copilot Styles */
        .copilot-fab {
            position: fixed;
            bottom: 30px;
            right: 30px;
            width: 60px;
            height: 60px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            border-radius: 50%;
            box-shadow: 0 4px 20px rgba(102, 126, 234, 0.4);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            color: white;
            transition: all 0.3s ease;
            z-index: 1000;
        }

        .copilot-fab:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 25px rgba(102, 126, 234, 0.6);
        }

        .copilot-chat {
            position: fixed;
            bottom: 100px;
            right: 30px;
            width: 350px;
            height: 500px;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
            display: none;
            flex-direction: column;
            z-index: 999;
            overflow: hidden;
        }

        .copilot-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .copilot-header h4 {
            margin: 0;
            font-size: 1.1rem;
        }

        .copilot-close {
            background: none;
            border: none;
            color: white;
            font-size: 1.2rem;
            cursor: pointer;
            padding: 5px;
            border-radius: 50%;
            transition: background 0.3s ease;
        }

        .copilot-close:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .copilot-messages {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .message {
            max-width: 80%;
            padding: 12px 16px;
            border-radius: 15px;
            font-size: 0.9rem;
            line-height: 1.4;
        }

        .message.user {
            background: #667eea;
            color: white;
            align-self: flex-end;
            border-bottom-right-radius: 5px;
        }

        .message.bot {
            background: #f8f9fa;
            color: #333;
            align-self: flex-start;
            border-bottom-left-radius: 5px;
            border: 1px solid #e9ecef;
        }

        .message.typing {
            background: #f8f9fa;
            color: #6c757d;
            align-self: flex-start;
            border-bottom-left-radius: 5px;
            border: 1px solid #e9ecef;
        }

        .typing-dots {
            display: inline-flex;
            gap: 4px;
        }

        .typing-dots span {
            width: 6px;
            height: 6px;
            background: #6c757d;
            border-radius: 50%;
            animation: typing 1.4s infinite;
        }

        .typing-dots span:nth-child(2) {
            animation-delay: 0.2s;
        }

        .typing-dots span:nth-child(3) {
            animation-delay: 0.4s;
        }

        @keyframes typing {
            0%, 60%, 100% {
                transform: translateY(0);
                opacity: 0.4;
            }
            30% {
                transform: translateY(-10px);
                opacity: 1;
            }
        }

        .copilot-input-area {
            padding: 20px;
            border-top: 1px solid #e9ecef;
            background: #f8f9fa;
        }

        .copilot-quick-replies {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 15px;
        }

        .quick-reply {
            background: white;
            border: 1px solid #667eea;
            color: #667eea;
            padding: 6px 12px;
            border-radius: 15px;
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .quick-reply:hover {
            background: #667eea;
            color: white;
        }

        .copilot-input-box {
            display: flex;
            gap: 10px;
        }

        .copilot-input {
            flex: 1;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 20px;
            outline: none;
            font-size: 0.9rem;
        }

        .copilot-input:focus {
            border-color: #667eea;
        }

        .copilot-send {
            background: #667eea;
            border: none;
            color: white;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.3s ease;
        }

        .copilot-send:hover {
            background: #5a6fd8;
        }

        .copilot-send:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        @media (max-width: 768px) {
            .header h1 {
                font-size: 2rem;
            }
            
            .form-grid {
                grid-template-columns: 1fr;
            }
            
            .checkbox-group {
                grid-template-columns: 1fr;
            }
            
            .navigation {
                flex-direction: column;
            }
            
            .content {
                padding: 20px;
            }

            .copilot-chat {
                width: calc(100vw - 40px);
                right: 20px;
                left: 20px;
                height: 60vh;
            }

            .copilot-fab {
                right: 20px;
                bottom: 20px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🎓 Tư vấn Ngành học</h1>
            <p>Khám phá ngành học phù hợp tại FPT Polytechnic</p>
        </div>

        <div class="navigation">
            <button class="nav-btn active" onclick="showSection('survey')">
                📝 Khảo sát
            </button>
            <button class="nav-btn" onclick="showSection('results')">
                🎯 Kết quả
            </button>
            <button class="nav-btn" onclick="showSection('history')">
                📚 Lịch sử
            </button>
        </div>

        <div class="content">
            <!-- Survey Section -->
            <div id="survey" class="section active">


                <form id="surveyForm">
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="name">👤 Họ và tên:</label>
                            <input type="text" id="name" class="form-control" required>
                        </div>

                        <div class="form-group">
                            <label for="age">🎂 Tuổi:</label>
                            <input type="number" id="age" class="form-control" min="15" max="25" required>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="interests">🎨 Sở thích cá nhân:</label>
                        <textarea id="interests" class="form-control" rows="3" placeholder="Ví dụ: Chơi game, vẽ tranh, đọc sách, lập trình..."></textarea>
                    </div>

                    <div class="form-group">
                        <label for="skills">💪 Kỹ năng hoặc tố chất nổi bật:</label>
                        <textarea id="skills" class="form-control" rows="3" placeholder="Ví dụ: Tư duy logic tốt, khả năng giao tiếp, sáng tạo..."></textarea>
                    </div>

                    <div class="form-grid">
                        <div class="form-group">
                            <label for="mathScore">📊 Điểm Toán:</label>
                            <input type="number" id="mathScore" class="form-control" min="0" max="10" step="0.1">
                        </div>

                        <div class="form-group">
                            <label for="englishScore">🌍 Điểm Tiếng Anh:</label>
                            <input type="number" id="englishScore" class="form-control" min="0" max="10" step="0.1">
                        </div>

                        <div class="form-group">
                            <label for="literatureScore">📚 Điểm Văn:</label>
                            <input type="number" id="literatureScore" class="form-control" min="0" max="10" step="0.1">
                        </div>

                        <div class="form-group">
                            <label for="physicsScore">⚛️ Điểm Lý:</label>
                            <input type="number" id="physicsScore" class="form-control" min="0" max="10" step="0.1">
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="favoriteSubjects">❤️ Môn học yêu thích:</label>
                        <textarea id="favoriteSubjects" class="form-control" rows="2" placeholder="Ví dụ: Toán, Lý, Tin học, Văn, Sử..."></textarea>
                    </div>

                    <div class="form-group">
                        <label for="careerGoals">🎯 Định hướng nghề nghiệp:</label>
                        <textarea id="careerGoals" class="form-control" rows="3" placeholder="Ví dụ: Muốn trở thành lập trình viên, designer, quản lý dự án..."></textarea>
                    </div>

                    <div class="form-group">
                        <label for="studyHabits">📖 Thói quen học tập:</label>
                        <textarea id="studyHabits" class="form-control" rows="3" placeholder="Ví dụ: Thích học nhóm, tự học, học qua thực hành..."></textarea>
                    </div>

                    <div class="form-group">
                        <label>🌟 Mức độ yêu thích các lĩnh vực:</label>
                        <div class="checkbox-group">
                            <div class="checkbox-item">
                                <input type="range" id="technology" min="1" max="10" value="5">
                                <label for="technology">💻 Công nghệ: <span id="technologyValue">5</span>/10</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="range" id="creativity" min="1" max="10" value="5">
                                <label for="creativity">🎨 Sáng tạo: <span id="creativityValue">5</span>/10</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="range" id="communication" min="1" max="10" value="5">
                                <label for="communication">🗣️ Giao tiếp: <span id="communicationValue">5</span>/10</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="range" id="logic" min="1" max="10" value="5">
                                <label for="logic">🧠 Logic: <span id="logicValue">5</span>/10</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="range" id="business" min="1" max="10" value="5">
                                <label for="business">💼 Kinh doanh: <span id="businessValue">5</span>/10</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="range" id="manual" min="1" max="10" value="5">
                                <label for="manual">🔧 Thực hành: <span id="manualValue">5</span>/10</label>
                            </div>
                        </div>
                    </div>

                    <div style="text-align: center; margin-top: 40px;">
                        <button type="submit" class="btn btn-primary">
                            🚀 Phân tích và Tư vấn
                        </button>
                    </div>
                </form>

                <div id="loading" class="loading">
                    <div class="spinner"></div>
                    <p>Đang phân tích thông tin của bạn...</p>
                    <div class="progress-bar">
                        <div class="progress-fill" id="progressFill"></div>
                    </div>
                </div>
            </div>

            <!-- Results Section -->
            <div id="results" class="section">
                <div id="resultsContent">
                    <div class="empty-state">
                        <div style="font-size: 4rem; margin-bottom: 20px;">🎯</div>
                        <h3>Chưa có kết quả tư vấn</h3>
                        <p>Hãy hoàn thành khảo sát để nhận được tư vấn ngành học phù hợp</p>
                    </div>
                </div>
            </div>

            <!-- History Section -->
            <div id="history" class="section">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px;">
                    <h2>📚 Lịch sử tư vấn</h2>
                    <button onclick="clearHistory()" class="btn btn-secondary">🗑️ Xóa lịch sử</button>
                </div>
                <div id="historyContent">
                    <div class="empty-state">
                        <div style="font-size: 4rem; margin-bottom: 20px;">📚</div>
                        <h3>Chưa có lịch sử tư vấn</h3>
                        <p>Các kết quả tư vấn của bạn sẽ được lưu lại ở đây</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Copilot Chat -->
    <button class="copilot-fab" onclick="toggleCopilot()" title="Trợ lý AI Copilot">
        🤖
    </button>

    <div id="copilotChat" class="copilot-chat">
        <div class="copilot-header">
            <h4>🤖 AI Copilot</h4>
            <button class="copilot-close" onclick="toggleCopilot()">✕</button>
        </div>
        
        <div id="copilotMessages" class="copilot-messages">
            <div class="message bot">
                Xin chào! Tôi là AI Copilot của FPT Polytechnic. Tôi có thể giúp bạn:
                <br>• Tư vấn về các ngành học
                <br>• Giải thích kết quả phân tích
                <br>• Hướng dẫn sử dụng ứng dụng
                <br><br>Bạn cần hỗ trợ gì không? 😊
            </div>
        </div>

        <div class="copilot-input-area">
            <div class="copilot-quick-replies" id="quickReplies">
                <button class="quick-reply" onclick="sendQuickReply('Ngành nào phù hợp với tôi?')">
                    Ngành nào phù hợp?
                </button>
                <button class="quick-reply" onclick="sendQuickReply('Giải thích kết quả phân tích')">
                    Giải thích kết quả
                </button>
                <button class="quick-reply" onclick="sendQuickReply('Tôi nên học gì để chuẩn bị?')">
                    Chuẩn bị gì?
                </button>
                <button class="quick-reply" onclick="sendQuickReply('Triển vọng nghề nghiệp')">
                    Triển vọng nghề nghiệp
                </button>
            </div>
            
            <div class="copilot-input-box">
                <input type="text" id="copilotInput" class="copilot-input" placeholder="Nhập câu hỏi của bạn..." onkeypress="handleCopilotKeyPress(event)">
                <button id="copilotSend" class="copilot-send" onclick="sendCopilotMessage()">
                    ➤
                </button>
            </div>
        </div>
    </div>

    <script>
        // FPT Polytechnic majors data
        const fptMajors = {
            "technology": [
                "Phát triển phần mềm",
                "Thiết kế đồ họa",
                "Ứng dụng phần mềm",
                "Quản trị mạng máy tính",
                "Thiết kế trang web"
            ],
            "business": [
                "Quản trị kinh doanh",
                "Kế toán",
                "Marketing",
                "Logistics",
                "Quản lý khách sạn"
            ],
            "creative": [
                "Thiết kế đồ họa",
                "Thiết kế nội thất",
                "Thiết kế thời trang",
                "Quay phim và biên tập"
            ],
            "engineering": [
                "Công nghệ ô tô",
                "Điện tử viễn thông",
                "Cơ khí máy tính",
                "Điện công nghiệp"
            ]
        };

        // API Configuration - Chỉnh sửa API key tại đây
        const API_CONFIG = {
            provider: 'demo', // 'openai', 'gemini', hoặc 'demo' (không cần API key)
            apiKey: '0xR9Dv4BcLfQgDNLpTQgvfMAimMqqG4gB3gAWPVX' // Thay thế bằng API key thực của bạn (bắt đầu bằng sk-)
        };

        // Initialize sliders
        document.addEventListener('DOMContentLoaded', function() {
            const sliders = ['technology', 'creativity', 'communication', 'logic', 'business', 'manual'];
            sliders.forEach(slider => {
                const element = document.getElementById(slider);
                const valueElement = document.getElementById(slider + 'Value');
                
                element.addEventListener('input', function() {
                    valueElement.textContent = this.value;
                });
            });

            loadHistory();
        });

        function showSection(sectionName) {
            // Hide all sections
            const sections = document.querySelectorAll('.section');
            sections.forEach(section => section.classList.remove('active'));
            
            // Show selected section
            document.getElementById(sectionName).classList.add('active');
            
            // Update navigation
            const navBtns = document.querySelectorAll('.nav-btn');
            navBtns.forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
        }

        document.getElementById('surveyForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            if (!API_CONFIG.apiKey || API_CONFIG.apiKey === 'YOUR_API_KEY_HERE') {
                alert('Vui lòng cấu hình API Key trong code trước khi sử dụng!');
                return;
            }

            // Show loading
            document.getElementById('loading').style.display = 'block';
            document.getElementById('surveyForm').style.display = 'none';
            
            // Simulate progress
            simulateProgress();
            
            // Collect form data
            const formData = collectFormData();
            
            try {
                // Call AI API
                const result = await analyzeWithAI(formData);
                
                // Display results
                displayResults(result, formData);
                
                // Save to history
                saveToHistory(result, formData);
                
                // Switch to results tab
                showSection('results');
                document.querySelector('[onclick="showSection(\'results\')"]').classList.add('active');
                document.querySelector('[onclick="showSection(\'survey\')"]').classList.remove('active');
                
            } catch (error) {
                alert('Có lỗi xảy ra khi phân tích: ' + error.message);
            } finally {
                // Hide loading
                document.getElementById('loading').style.display = 'none';
                document.getElementById('surveyForm').style.display = 'block';
            }
        });

        function collectFormData() {
            return {
                name: document.getElementById('name').value,
                age: document.getElementById('age').value,
                interests: document.getElementById('interests').value,
                skills: document.getElementById('skills').value,
                scores: {
                    math: document.getElementById('mathScore').value,
                    english: document.getElementById('englishScore').value,
                    literature: document.getElementById('literatureScore').value,
                    physics: document.getElementById('physicsScore').value
                },
                favoriteSubjects: document.getElementById('favoriteSubjects').value,
                careerGoals: document.getElementById('careerGoals').value,
                studyHabits: document.getElementById('studyHabits').value,
                preferences: {
                    technology: document.getElementById('technology').value,
                    creativity: document.getElementById('creativity').value,
                    communication: document.getElementById('communication').value,
                    logic: document.getElementById('logic').value,
                    business: document.getElementById('business').value,
                    manual: document.getElementById('manual').value
                }
            };
        }

        async function analyzeWithAI(formData) {
            const provider = API_CONFIG.provider;
            const apiKey = API_CONFIG.apiKey;
            
            const prompt = `
Bạn là chuyên gia tư vấn giáo dục. Dựa trên thông tin sau của học sinh, hãy phân tích và đưa ra 3 gợi ý ngành học phù hợp nhất tại FPT Polytechnic:

Thông tin học sinh:
- Tên: ${formData.name}
- Tuổi: ${formData.age}
- Sở thích: ${formData.interests}
- Kỹ năng nổi bật: ${formData.skills}
- Điểm số: Toán ${formData.scores.math}, Anh ${formData.scores.english}, Văn ${formData.scores.literature}, Lý ${formData.scores.physics}
- Môn yêu thích: ${formData.favoriteSubjects}
- Định hướng nghề nghiệp: ${formData.careerGoals}
- Thói quen học tập: ${formData.studyHabits}
- Mức độ yêu thích (1-10): Công nghệ ${formData.preferences.technology}, Sáng tạo ${formData.preferences.creativity}, Giao tiếp ${formData.preferences.communication}, Logic ${formData.preferences.logic}, Kinh doanh ${formData.preferences.business}, Thực hành ${formData.preferences.manual}

Các ngành học có tại FPT Polytechnic:
Công nghệ: Phát triển phần mềm, Thiết kế đồ họa, Ứng dụng phần mềm, Quản trị mạng máy tính, Thiết kế trang web
Kinh doanh: Quản trị kinh doanh, Kế toán, Marketing, Logistics, Quản lý khách sạn
Sáng tạo: Thiết kế đồ họa, Thiết kế nội thất, Thiết kế thời trang, Quay phim và biên tập
Kỹ thuật: Công nghệ ô tô, Điện tử viễn thông, Cơ khí máy tính, Điện công nghiệp

Hãy trả về JSON với format:
{
  "analysis": "Phân tích tổng quan về học sinh",
  "recommendations": [
    {
      "major": "Tên ngành học",
      "compatibility": "95%",
      "reasons": ["Lý do 1", "Lý do 2", "Lý do 3"],
      "career_prospects": "Triển vọng nghề nghiệp",
      "skills_needed": "Kỹ năng cần phát triển"
    }
  ]
}
`;

            if (provider === 'openai') {
                try {
                    const response = await fetch('https://api.openai.com/v1/chat/completions', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${apiKey}`
                        },
                        body: JSON.stringify({
                            model: 'gpt-3.5-turbo',
                            messages: [
                                { role: 'system', content: 'Bạn là chuyên gia tư vấn giáo dục chuyên nghiệp.' },
                                { role: 'user', content: prompt }
                            ],
                            temperature: 0.7
                        })
                    });

                    if (!response.ok) {
                        const errorData = await response.json().catch(() => null);
                        const errorMessage = errorData?.error?.message || response.statusText || 'Unknown error';
                        throw new Error(`API OpenAI Error: ${errorMessage}`);
                    }

                    const data = await response.json();
                    return JSON.parse(data.choices[0].message.content);
                } catch (error) {
                    console.error('OpenAI API Error:', error);
                    // Fallback to demo data if API fails
                    return getDemoAnalysisResult(formData);
                }
            } else {
                // For other providers or demo mode
                return getDemoAnalysisResult(formData);
            }
        }

        function getDemoAnalysisResult(formData) {
            // Analyze preferences to suggest appropriate majors
            const prefs = formData.preferences;
            const scores = formData.scores;
            
            let recommendations = [];
            
            // Technology majors
            if (prefs.technology >= 7 || prefs.logic >= 7 || scores.math >= 7) {
                recommendations.push({
                    major: "Phát triển phần mềm",
                    compatibility: "92%",
                    reasons: ["Điểm toán cao", "Yêu thích công nghệ", "Tư duy logic tốt"],
                    career_prospects: "Lập trình viên, Software Engineer, Full-stack Developer",
                    skills_needed: "Học thêm các ngôn ngữ lập trình, thuật toán"
                });
            }
            
            // Creative majors
            if (prefs.creativity >= 7 || prefs.manual >= 6) {
                recommendations.push({
                    major: "Thiết kế đồ họa",
                    compatibility: "85%",
                    reasons: ["Có khả năng sáng tạo", "Yêu thích thiết kế"],
                    career_prospects: "Graphic Designer, UI/UX Designer",
                    skills_needed: "Adobe Creative Suite, Figma"
                });
            }
            
            // Business majors
            if (prefs.business >= 7 || prefs.communication >= 7) {
                recommendations.push({
                    major: "Quản trị kinh doanh",
                    compatibility: "88%",
                    reasons: ["Khả năng giao tiếp tốt", "Yêu thích kinh doanh"],
                    career_prospects: "Quản lý dự án, Kinh doanh, Marketing",
                    skills_needed: "Kỹ năng lãnh đạo, phân tích thị trường"
                });
            }
            
            // Ensure at least 3 recommendations
            if (recommendations.length < 3) {
                recommendations.push({
                    major: "Quản trị mạng máy tính",
                    compatibility: "82%",
                    reasons: ["Phù hợp với xu hướng công nghệ", "Triển vọng tốt"],
                    career_prospects: "Network Administrator, System Engineer",
                    skills_needed: "Cisco, Microsoft certifications"
                });
            }
            
            return {
                analysis: `Dựa trên thông tin của ${formData.name}, tôi nhận thấy bạn có những điểm mạnh phù hợp với các ngành đào tạo tại FPT Polytechnic. Với sở thích và kỹ năng hiện tại, bạn có tiềm năng phát triển tốt trong các lĩnh vực được đề xuất.`,
                recommendations: recommendations.slice(0, 3)
            };
        }

        function displayResults(result, formData) {
            const resultsContent = document.getElementById('resultsContent');
            
            let html = `
                <div class="results-card">
                    <h3>🎯 Kết quả phân tích cho ${formData.name}</h3>
                    <p>${result.analysis}</p>
                </div>
            `;

            result.recommendations.forEach((rec, index) => {
                html += `
                    <div class="major-recommendation">
                        <h4>${index + 1}. ${rec.major} - Độ phù hợp: ${rec.compatibility}</h4>
                        <div style="margin-bottom: 15px;">
                            <strong>🎯 Lý do phù hợp:</strong>
                            <ul style="margin-left: 20px; margin-top: 5px;">
                                ${rec.reasons.map(reason => `<li>${reason}</li>`).join('')}
                            </ul>
                        </div>
                        <div style="margin-bottom: 15px;">
                            <strong>💼 Triển vọng nghề nghiệp:</strong>
                            <p style="margin-top: 5px;">${rec.career_prospects}</p>
                        </div>
                        <div>
                            <strong>📚 Kỹ năng cần phát triển:</strong>
                            <p style="margin-top: 5px;">${rec.skills_needed}</p>
                        </div>
                    </div>
                `;
            });

            resultsContent.innerHTML = html;
        }

        function saveToHistory(result, formData) {
            const history = JSON.parse(localStorage.getItem('counselingHistory') || '[]');
            
            const record = {
                id: Date.now(),
                date: new Date().toLocaleDateString('vi-VN'),
                time: new Date().toLocaleTimeString('vi-VN'),
                studentName: formData.name,
                result: result,
                formData: formData
            };

            history.unshift(record);
            
            // Keep only last 10 records
            if (history.length > 10) {
                history.splice(10);
            }

            localStorage.setItem('counselingHistory', JSON.stringify(history));
            loadHistory();
        }

        function loadHistory() {
            const history = JSON.parse(localStorage.getItem('counselingHistory') || '[]');
            const historyContent = document.getElementById('historyContent');

            if (history.length === 0) {
                historyContent.innerHTML = `
                    <div class="empty-state">
                        <div style="font-size: 4rem; margin-bottom: 20px;">📚</div>
                        <h3>Chưa có lịch sử tư vấn</h3>
                        <p>Các kết quả tư vấn của bạn sẽ được lưu lại ở đây</p>
                    </div>
                `;
                return;
            }

            let html = '';
            history.forEach(record => {
                html += `
                    <div class="history-item">
                        <div class="date">📅 ${record.date} - ⏰ ${record.time}</div>
                        <h4>👤 ${record.studentName}</h4>
                        <div style="margin-top: 15px;">
                            <strong>🎯 Ngành học được đề xuất:</strong>
                            <ul style="margin-left: 20px; margin-top: 5px;">
                                ${record.result.recommendations.map(rec => 
                                    `<li>${rec.major} (${rec.compatibility})</li>`
                                ).join('')}
                            </ul>
                        </div>
                        <button onclick="viewDetailHistory(${record.id})" class="btn btn-primary" style="margin-top: 15px; padding: 8px 16px; font-size: 0.9rem;">
                            👁️ Xem chi tiết
                        </button>
                    </div>
                `;
            });

            historyContent.innerHTML = html;
        }

        function viewDetailHistory(recordId) {
            const history = JSON.parse(localStorage.getItem('counselingHistory') || '[]');
            const record = history.find(r => r.id === recordId);
            
            if (record) {
                displayResults(record.result, record.formData);
                showSection('results');
                document.querySelector('[onclick="showSection(\'results\')"]').classList.add('active');
                document.querySelector('[onclick="showSection(\'history\')"]').classList.remove('active');
            }
        }

        function clearHistory() {
            if (confirm('Bạn có chắc chắn muốn xóa toàn bộ lịch sử tư vấn?')) {
                localStorage.removeItem('counselingHistory');
                loadHistory();
            }
        }

        function simulateProgress() {
            const progressFill = document.getElementById('progressFill');
            let progress = 0;
            
            const interval = setInterval(() => {
                progress += Math.random() * 15;
                if (progress > 100) progress = 100;
                
                progressFill.style.width = progress + '%';
                
                if (progress >= 100) {
                    clearInterval(interval);
                }
            }, 200);
        }

        // Copilot Functions
        let copilotHistory = [];
        let isCopilotOpen = false;

        function toggleCopilot() {
            const copilotChat = document.getElementById('copilotChat');
            isCopilotOpen = !isCopilotOpen;
            
            if (isCopilotOpen) {
                copilotChat.style.display = 'flex';
                copilotChat.style.animation = 'fadeIn 0.3s ease';
            } else {
                copilotChat.style.display = 'none';
            }
        }

        function sendQuickReply(message) {
            document.getElementById('copilotInput').value = message;
            sendCopilotMessage();
        }

        function handleCopilotKeyPress(event) {
            if (event.key === 'Enter') {
                sendCopilotMessage();
            }
        }

        async function sendCopilotMessage() {
            const input = document.getElementById('copilotInput');
            const message = input.value.trim();
            
            if (!message) return;

            // Add user message
            addCopilotMessage(message, 'user');
            input.value = '';
            
            // Show typing indicator
            const typingDiv = addCopilotMessage('', 'typing');
            typingDiv.innerHTML = '<div class="typing-dots"><span></span><span></span><span></span></div>';
            
            try {
                // Get AI response
                const response = await getCopilotResponse(message);
                
                // Remove typing indicator
                typingDiv.remove();
                
                // Add bot response
                addCopilotMessage(response, 'bot');
                
            } catch (error) {
                // Remove typing indicator
                typingDiv.remove();
                
                // Add error message
                addCopilotMessage('Xin lỗi, tôi đang gặp sự cố. Vui lòng thử lại sau.', 'bot');
            }
        }

        function addCopilotMessage(message, sender) {
            const messagesContainer = document.getElementById('copilotMessages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${sender}`;
            messageDiv.innerHTML = message;
            
            messagesContainer.appendChild(messageDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
            
            return messageDiv;
        }

        async function getCopilotResponse(userMessage) {
            if (!API_CONFIG.apiKey || API_CONFIG.apiKey === 'YOUR_API_KEY_HERE') {
                return 'Để sử dụng tính năng chat, vui lòng cấu hình API Key trong code. 🔑';
            }

            // Check for predefined responses first
            const predefinedResponse = getPredefinedResponse(userMessage);
            if (predefinedResponse) {
                return predefinedResponse;
            }

            const provider = API_CONFIG.provider;
            const apiKey = API_CONFIG.apiKey;
            
            // Build context from user's current session
            const currentFormData = getCurrentFormData();
            const lastResult = getLastAnalysisResult();
            
            const systemPrompt = `
Bạn là AI Copilot của FPT Polytechnic, chuyên gia tư vấn giáo dục thân thiện và hữu ích. 

Thông tin về FPT Polytechnic:
- Các ngành Công nghệ: Phát triển phần mềm, Thiết kế đồ họa, Ứng dụng phần mềm, Quản trị mạng máy tính, Thiết kế trang web
- Các ngành Kinh doanh: Quản trị kinh doanh, Kế toán, Marketing, Logistics, Quản lý khách sạn  
- Các ngành Sáng tạo: Thiết kế nội thất, Thiết kế thời trang, Quay phim và biên tập
- Các ngành Kỹ thuật: Công nghệ ô tô, Điện tử viễn thông, Cơ khí máy tính, Điện công nghiệp

Hãy trả lời ngắn gọn, thân thiện và hữu ích. Sử dụng emoji phù hợp.
${currentFormData ? `\nThông tin người dùng hiện tại: ${JSON.stringify(currentFormData)}` : ''}
${lastResult ? `\nKết quả phân tích gần nhất: ${JSON.stringify(lastResult)}` : ''}
`;

            if (provider === 'openai') {
                const response = await fetch('https://api.openai.com/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${apiKey}`
                    },
                    body: JSON.stringify({
                        model: 'gpt-3.5-turbo',
                        messages: [
                            { role: 'system', content: systemPrompt },
                            ...copilotHistory.slice(-10), // Keep last 10 messages for context
                            { role: 'user', content: userMessage }
                        ],
                        temperature: 0.7,
                        max_tokens: 300
                    })
                });

                if (!response.ok) {
                    throw new Error('Lỗi API');
                }

                const data = await response.json();
                const botResponse = data.choices[0].message.content;
                
                // Update history
                copilotHistory.push(
                    { role: 'user', content: userMessage },
                    { role: 'assistant', content: botResponse }
                );
                
                return botResponse;
            } else {
                // Fallback response for other providers
                return getPredefinedResponse(userMessage) || 
                       'Tôi hiểu bạn muốn biết về ' + userMessage + '. Để được tư vấn chi tiết hơn, bạn có thể hoàn thành bài khảo sát trước nhé! 😊';
            }
        }

        function getPredefinedResponse(message) {
            const lowerMessage = message.toLowerCase();
            
            // Ngành học
            if (lowerMessage.includes('ngành') && (lowerMessage.includes('phù hợp') || lowerMessage.includes('suitable'))) {
                return `
🎯 Để tìm ngành học phù hợp, tôi cần hiểu về bạn hơn! Hãy hoàn thành bài khảo sát để tôi có thể đưa ra tư vấn chính xác nhất.

Một số ngành phổ biến tại FPT Polytechnic:
• 💻 **Công nghệ**: Phát triển phần mềm, Thiết kế đồ họa
• 💼 **Kinh doanh**: Quản trị kinh doanh, Marketing  
• 🎨 **Sáng tạo**: Thiết kế nội thất, Thời trang
• 🔧 **Kỹ thuật**: Công nghệ ô tô, Điện tử viễn thông
                `;
            }
            
            // Kết quả phân tích
            if (lowerMessage.includes('giải thích') && lowerMessage.includes('kết quả')) {
                const lastResult = getLastAnalysisResult();
                if (lastResult) {
                    return `
📊 **Giải thích kết quả phân tích của bạn:**

${lastResult.analysis}

**Top 3 ngành được đề xuất:**
${lastResult.recommendations.map((rec, index) => 
    `${index + 1}. **${rec.major}** (${rec.compatibility})\n   💡 Lý do: ${rec.reasons.join(', ')}`
).join('\n\n')}

Bạn có câu hỏi gì về các ngành này không? 😊
                    `;
                } else {
                    return 'Bạn chưa có kết quả phân tích nào. Hãy hoàn thành bài khảo sát trước nhé! 📝';
                }
            }
            
            // Chuẩn bị
            if (lowerMessage.includes('chuẩn bị') || lowerMessage.includes('học gì')) {
                return `
📚 **Để chuẩn bị cho việc học tại FPT Polytechnic:**

**Kỹ năng chung:**
• 🇬🇧 Tiếng Anh cơ bản (nhiều tài liệu tiếng Anh)
• 💻 Tin học văn phòng cơ bản
• 🧠 Tư duy logic và giải quyết vấn đề

**Theo từng lĩnh vực:**
• **Công nghệ**: Toán học, logic, khám phá lập trình cơ bản
• **Kinh doanh**: Toán, khả năng giao tiếp, hiểu biết xã hội
• **Sáng tạo**: Mỹ thuật, thẩm mỹ, phần mềm thiết kế
• **Kỹ thuật**: Toán, Vật lý, tư duy không gian

Bạn quan tâm lĩnh vực nào nhất? 🤔
                `;
            }
            
            // Triển vọng nghề nghiệp
            if (lowerMessage.includes('triển vọng') || lowerMessage.includes('nghề nghiệp')) {
                return `
🚀 **Triển vọng nghề nghiệp tại FPT Polytechnic rất tốt!**

**Tỷ lệ có việc làm:** > 95% sau tốt nghiệp

**Mức lương khởi điểm:**
• 💻 IT: 8-15 triệu/tháng
• 💼 Kinh doanh: 7-12 triệu/tháng  
• 🎨 Thiết kế: 6-10 triệu/tháng
• 🔧 Kỹ thuật: 7-13 triệu/tháng

**Cơ hội phát triển:**
• Thực tập tại các doanh nghiệp lớn
• Kết nối mạng lưới FPT Corporation
• Chương trình đào tạo quốc tế
• Khởi nghiệp với sự hỗ trợ từ trường

Bạn muốn biết thêm về ngành nào cụ thể? 🎯
                `;
            }
            
            // Hướng dẫn sử dụng
            if (lowerMessage.includes('hướng dẫn') || lowerMessage.includes('sử dụng')) {
                return `
📖 **Hướng dẫn sử dụng ứng dụng:**

**Bước 1:** Điền đầy đủ thông tin trong form khảo sát 📝
**Bước 2:** Nhấn "Phân tích và Tư vấn" 🚀
**Bước 3:** Xem kết quả tư vấn chi tiết 🎯
**Bước 4:** Kiểm tra lịch sử các lần tư vấn 📚

**Mẹo:** 
• Trả lời thành thật để có kết quả chính xác nhất
• Điểm số các môn giúp đánh giá năng lực học tập
• Sở thích cá nhân rất quan trọng cho sự phù hợp

Bạn cần hỗ trợ thêm gì không? 😊
                `;
            }
            
            // Chào hỏi
            if (lowerMessage.includes('xin chào') || lowerMessage.includes('hello') || lowerMessage.includes('hi')) {
                return `
👋 Xin chào! Tôi là AI Copilot của FPT Polytechnic!

Tôi có thể giúp bạn:
• 🎯 Tư vấn ngành học phù hợp
• 📊 Giải thích kết quả phân tích  
• 📚 Hướng dẫn chuẩn bị học tập
• 🚀 Thông tin triển vọng nghề nghiệp

Bạn muốn bắt đầu từ đâu? 😊
                `;
            }
            
            return null;
        }

        function getCurrentFormData() {
            try {
                const name = document.getElementById('name')?.value || '';
                if (!name) return null;
                
                return {
                    name: name,
                    interests: document.getElementById('interests')?.value || '',
                    skills: document.getElementById('skills')?.value || '',
                    favoriteSubjects: document.getElementById('favoriteSubjects')?.value || '',
                    careerGoals: document.getElementById('careerGoals')?.value || ''
                };
            } catch (error) {
                return null;
            }
        }

        function getLastAnalysisResult() {
            try {
                const history = JSON.parse(localStorage.getItem('counselingHistory') || '[]');
                return history.length > 0 ? history[0].result : null;
            } catch (error) {
                return null;
            }
        }
    </script>
</body>
</html>
